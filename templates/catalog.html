{% extends "base.html" %}

{% block content %}
<div class="page">
    <header class="page-header">
        <h1>–ö–∞—Ç–∞–ª–æ–≥ –≤–µ–π–ø–æ–≤</h1>
    </header>

    <!-- –§–∏–ª—å—Ç—Ä —Ä–∞–∑–¥–µ–ª–æ–≤ -->
    <div class="catalog-filters">
        <div class="filter-container">
            <div class="filter-section">
                <div class="filter-label">–†–∞–∑–¥–µ–ª:</div>
                <select id="section-filter" class="filter-select">
                    <option value="all">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>
                    {% for section in sections %}
                    <option value="{{ section.name }}" {% if section.name == section %}selected{% endif %}>
                        {{ section.icon or 'üì¶' }} {{ section.display_name or section.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–¥–µ–ª–∞) -->
            <div class="filter-section" id="category-filter-section" style="display: none;">
                <div class="filter-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</div>
                <div class="category-buttons" id="category-buttons-container">
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <div class="clear-category" id="clear-category-btn" style="display: none;">
                    <button type="button" class="clear-category-btn" onclick="clearCategoryFilter()">‚úï –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ (2 –∫–æ–ª–æ–Ω–∫–∏) -->
    <div class="products-grid" id="products-grid">
        {% for product in products %}
        <div class="product-card" onclick="window.location.href='{{ url_for('product_detail', product_id=product.id) }}'">
            <div class="product-image">
                <img src="{{ product.image_path }}" alt="{{ product.name }}" 
                     onerror="this.src='/static/images/default-product.png'">
            </div>
            <div class="product-info">
                <h3 class="product-name">{{ product.name }}</h3>
                <p class="product-description">{{ product.description[:60] }}{% if product.description|length > 60 %}...{% endif %}</p>
                <div class="product-price">{{ product.price }} —Ä—É–±.</div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not products %}
    <div class="empty-catalog">
        <div class="empty-icon">üì¶</div>
        <h3>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</p>
    </div>
    {% endif %}
</div>

<style>
.page-header {
    padding: 20px 20px 10px 20px;
    text-align: center;
    margin-top: 20px;
}

.page-header h1 {
    font-size: 24px;
    margin-bottom: 10px;
    color: #fff;
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */
.catalog-filters {
    padding: 0 15px 15px 15px;
    position: sticky;
    top: 0;
    z-index: 50;
    background: #0f0f0f;
}

.filter-container {
    background: #1a1a1a;
    border-radius: 15px;
    padding: 15px;
    border: 1px solid #333;
}

.filter-section {
    margin-bottom: 15px;
}

.filter-section:last-child {
    margin-bottom: 0;
}

.filter-label {
    font-size: 14px;
    color: #888;
    margin-bottom: 8px;
    font-weight: 500;
}

.filter-select {
    width: 100%;
    background: #2a2a2a;
    border: 1px solid #333;
    color: white;
    padding: 12px 15px;
    border-radius: 10px;
    font-size: 14px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 20px;
    transition: all 0.3s;
}

.filter-select:focus {
    outline: none;
    border-color: #00ff88;
    box-shadow: 0 0 0 2px rgba(0,255,136,0.1);
}

/* –ö–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
.category-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 5px;
}

.category-btn {
    background: #2a2a2a;
    border: 1px solid #333;
    color: #ccc;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.category-btn:hover {
    background: #333;
    border-color: #555;
}

.category-btn.active {
    background: #00ff88;
    color: #000;
    border-color: #00ff88;
    font-weight: 500;
}

.category-btn.all-categories {
    background: #333;
    color: #fff;
    border-color: #555;
}

.category-btn.all-categories.active {
    background: #00ff88;
    color: #000;
    border-color: #00ff88;
}

.clear-category {
    margin-top: 10px;
    text-align: center;
}

.clear-category-btn {
    background: transparent;
    border: 1px solid #ff4444;
    color: #ff4444;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.clear-category-btn:hover {
    background: rgba(255, 68, 68, 0.1);
}

/* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
.products-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 0 15px 80px 15px;
}

.product-card {
    background: #1a1a1a;
    border-radius: 12px;
    padding: 12px;
    transition: all 0.3s ease;
    border: 1px solid #333;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    height: 260px;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,255,136,0.15);
    border-color: #00ff88;
}

.product-image {
    width: 100%;
    height: 140px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 10px;
    background: #2a2a2a;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.product-image img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: scale-down;
    transition: transform 0.3s ease;
}

.product-card:hover .product-image img {
    transform: scale(1.05);
}

.product-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.product-name {
    font-size: 13px;
    margin-bottom: 6px;
    color: #fff;
    font-weight: 500;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-description {
    font-size: 11px;
    color: #888;
    margin-bottom: 8px;
    line-height: 1.3;
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-price {
    color: #00ff88;
    font-weight: bold;
    font-size: 15px;
    margin-top: auto;
}

.empty-catalog {
    text-align: center;
    padding: 60px 20px;
    color: #888;
}

.empty-icon {
    font-size: 60px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-catalog h3 {
    margin-bottom: 10px;
    font-size: 18px;
    color: #fff;
}

.empty-catalog p {
    color: #888;
    font-size: 14px;
}

.loading-categories {
    text-align: center;
    padding: 20px;
    color: #888;
    font-size: 14px;
    width: 100%;
}

.no-categories {
    text-align: center;
    padding: 20px;
    color: #888;
    font-size: 14px;
    background: #2a2a2a;
    border-radius: 8px;
    border: 1px solid #333;
}

.error-categories {
    text-align: center;
    padding: 20px;
    color: #ff4444;
    font-size: 14px;
    background: #2a2a2a;
    border-radius: 8px;
    border: 1px solid #ff4444;
}

.loading-products {
    text-align: center;
    padding: 40px;
    color: #888;
    font-size: 16px;
    grid-column: span 2;
}

.error {
    text-align: center;
    padding: 40px;
    color: #ff4444;
    font-size: 16px;
    grid-column: span 2;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 360px) {
    .products-grid {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 0 10px 80px 10px;
    }
    
    .catalog-filters {
        padding: 0 10px 10px 10px;
    }
    
    .filter-container {
        padding: 12px;
    }
    
    .product-card {
        height: 240px;
    }
    
    .product-image {
        height: 120px;
    }
    
    .category-buttons {
        gap: 6px;
    }
    
    .category-btn {
        padding: 6px 10px;
        font-size: 12px;
    }
}

@media (min-width: 768px) {
    .products-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        padding: 0 20px 80px 20px;
    }
    
    .catalog-filters {
        padding: 0 20px 20px 20px;
    }
    
    .filter-container {
        padding: 20px;
    }
    
    .product-card {
        height: 280px;
    }
    
    .product-image {
        height: 150px;
    }
    
    .category-buttons {
        gap: 10px;
    }
    
    .category-btn {
        padding: 10px 15px;
        font-size: 14px;
    }
}
</style>

<script>
// –¢–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
let currentSection = 'all';
let currentCategory = 'all';
let allProducts = [];
let currentProducts = [];

document.addEventListener('DOMContentLoaded', function() {
    vapeShop.highlightActiveNav();
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const sectionParam = urlParams.get('section') || 'all';
    const categoryParam = urlParams.get('category') || 'all';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã
    const productElements = document.querySelectorAll('.product-card');
    allProducts = Array.from(productElements).map(el => ({
        id: el.getAttribute('onclick')?.match(/product\/(\d+)/)?.[1] || '',
        name: el.querySelector('.product-name')?.textContent || '',
        description: el.querySelector('.product-description')?.textContent || '',
        price: el.querySelector('.product-price')?.textContent || '',
        image: el.querySelector('img')?.src || ''
    }));
    currentProducts = [...allProducts];
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
    currentSection = sectionParam;
    currentCategory = categoryParam;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ñ–∏–ª—å—Ç—Ä–µ —Ä–∞–∑–¥–µ–ª–æ–≤
    const sectionFilter = document.getElementById('section-filter');
    if (sectionFilter) {
        sectionFilter.value = currentSection;
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–∞–∑–¥–µ–ª (–Ω–µ "–≤—Å–µ"), –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if (currentSection !== 'all') {
            loadCategoriesForSection(currentSection);
            showCategoryFilter();
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –ø–æ–º–µ—á–∞–µ–º –µ–µ –∞–∫—Ç–∏–≤–Ω–æ–π
            if (currentCategory !== 'all') {
                setTimeout(() => {
                    markCategoryAsActive(currentCategory);
                }, 300);
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞
    if (sectionFilter) {
        sectionFilter.addEventListener('change', function() {
            const sectionId = this.value;
            handleSectionChange(sectionId);
        });
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞
function handleSectionChange(sectionId) {
    currentSection = sectionId;
    currentCategory = 'all'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–∞–∑–¥–µ–ª–∞
    
    if (sectionId === 'all') {
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        hideCategoryFilter();
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
        updateProducts();
    } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        showCategoryFilter();
        loadCategoriesForSection(sectionId);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updateURL();
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function showCategoryFilter() {
    const categorySection = document.getElementById('category-filter-section');
    if (categorySection) {
        categorySection.style.display = 'block';
    }
}

// –°–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function hideCategoryFilter() {
    const categorySection = document.getElementById('category-filter-section');
    if (categorySection) {
        categorySection.style.display = 'none';
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
function loadCategoriesForSection(sectionId) {
    const container = document.getElementById('category-buttons-container');
    const clearBtn = document.getElementById('clear-category-btn');
    
    if (!container) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    container.innerHTML = '<div class="loading-categories">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</div>';
    
    fetch(`/api/categories/section/${sectionId}`)
        .then(response => response.json())
        .then(categories => {
            if (categories.length === 0) {
                container.innerHTML = '<div class="no-categories">–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
                if (clearBtn) clearBtn.style.display = 'none';
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            let html = `
                <button type="button" class="category-btn all-categories active" onclick="selectCategory('all')">
                    –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                </button>
            `;
            
            categories.forEach(category => {
                html += `
                    <button type="button" class="category-btn" data-category-id="${category.id}" onclick="selectCategory('${category.id}')">
                        ${category.name}
                    </button>
                `;
            });
            
            container.innerHTML = html;
            if (clearBtn) clearBtn.style.display = 'block';
            
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            container.innerHTML = '<div class="error-categories">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
            if (clearBtn) clearBtn.style.display = 'none';
        });
}

// –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function selectCategory(categoryId) {
    currentCategory = categoryId;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    markCategoryAsActive(categoryId);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã
    updateProducts();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º URL
    updateURL();
}

// –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
function markCategoryAsActive(categoryId) {
    const categoryButtons = document.querySelectorAll('.category-btn');
    categoryButtons.forEach(button => {
        const btnCategoryId = button.getAttribute('data-category-id') || 'all';
        if (btnCategoryId === categoryId) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
}

// –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function clearCategoryFilter() {
    currentCategory = 'all';
    markCategoryAsActive('all');
    updateProducts();
    updateURL();
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
function updateProducts() {
    let url = '/catalog';
    const params = [];
    
    if (currentSection !== 'all') {
        params.push(`section=${currentSection}`);
    }
    
    if (currentCategory !== 'all') {
        params.push(`category=${currentCategory}`);
    }
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const productsGrid = document.getElementById('products-grid');
    if (productsGrid) {
        productsGrid.innerHTML = '<div class="loading-products">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
    }
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –±–ª–æ–∫ –ø—É—Å—Ç–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    const oldEmptyCatalog = document.querySelector('.empty-catalog');
    if (oldEmptyCatalog) {
        oldEmptyCatalog.remove();
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —á–µ—Ä–µ–∑ AJAX
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.text())
        .then(html => {
            // –ü–∞—Ä—Å–∏–º HTML –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Ç–∫—É —Ç–æ–≤–∞—Ä–æ–≤
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –Ω–æ–≤–æ–º HTML
            const newProductsGrid = doc.querySelector('.products-grid');
            const newEmptyCatalog = doc.querySelector('.empty-catalog');
            
            if (productsGrid) {
                if (newProductsGrid && newProductsGrid.innerHTML.trim()) {
                    productsGrid.innerHTML = newProductsGrid.innerHTML;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã
                    const hasProducts = productsGrid.innerHTML.includes('product-card');
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å empty-catalog, –Ω–æ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã - —É–¥–∞–ª—è–µ–º –µ–≥–æ
                    if (newEmptyCatalog && hasProducts) {
                        const existingEmpty = document.querySelector('.empty-catalog');
                        if (existingEmpty) {
                            existingEmpty.remove();
                        }
                    }
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å empty-catalog –∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ - –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                    if (newEmptyCatalog && !hasProducts) {
                        productsGrid.insertAdjacentHTML('afterend', newEmptyCatalog.outerHTML);
                    }
                } else if (newEmptyCatalog) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    productsGrid.innerHTML = '';
                    productsGrid.insertAdjacentHTML('afterend', newEmptyCatalog.outerHTML);
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
            if (productsGrid) {
                productsGrid.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</div>';
            }
        });
}

// –û–±–Ω–æ–≤–∏—Ç—å URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function updateURL() {
    const params = [];
    
    if (currentSection !== 'all') {
        params.push(`section=${currentSection}`);
    }
    
    if (currentCategory !== 'all') {
        params.push(`category=${currentCategory}`);
    }
    
    let url = '/catalog';
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º URL –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.history.pushState({}, '', url);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥" –≤ –±—Ä–∞—É–∑–µ—Ä–µ
window.addEventListener('popstate', function() {
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    window.location.reload();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É —Å –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
function addToCartFromCard(productId, event) {
    event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞
    vapeShop.addToCart(productId);
}
</script>
{% endblock %}